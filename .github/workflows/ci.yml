name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required guardrail files
        run: |
          test -f CLAUDE.md
          test -f docs/specs/greenspace-2026-spec.md
          test -f docs/api/openapi.yaml
          test -f docs/data/schema.md
          test -f .github/pull_request_template.md

  app-checks:
    runs-on: ubuntu-latest
    needs: guardrails
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Node checks when package.json exists
        run: |
          if [ -f package.json ]; then
            npm ci
            npm test
            npm run lint
            npm run build
          else
            echo "Skipping app checks: root package.json not found yet."
          fi

  infra-checks:
    runs-on: ubuntu-latest
    needs: guardrails
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Run Terraform checks
        run: |
          TF_COUNT=$(find infra/terraform -name "*.tf" | wc -l | tr -d ' ')
          if [ "$TF_COUNT" = "0" ]; then
            echo "No Terraform files found. Skipping infra checks."
            exit 0
          fi

          terraform fmt -check -recursive infra/terraform

          for ENV_DIR in infra/terraform/environments/*; do
            if [ ! -d "$ENV_DIR" ]; then
              continue
            fi

            terraform -chdir="$ENV_DIR" init -backend=false
            terraform -chdir="$ENV_DIR" validate
            terraform -chdir="$ENV_DIR" plan -lock=false -refresh=false -input=false -out=tfplan
          done
